# *CVE-2021-40444 Microsoft MSHTML Remote Code Execution*
![Figure2-attack-chain](https://user-images.githubusercontent.com/90869009/160360721-c4683036-9a13-437e-b574-818fd57a932a.png)
                                   [[www.microsoft.com]](https://www.microsoft.com/security/blog/2021/09/15/analyzing-attacks-that-exploit-the-mshtml-cve-2021-40444-vulnerability/)

There is a security vulnerability **in MSHTML** that can allow an attacker to execute arbitrary code on a vulnerable system.[[1]](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-40444) Detecting Zero-Day vulnerabilities in MSHTML allows a hacker to infect a victim system with a Word file without using Macro!

The new CVE-2021-40444 vulnerability with a score of 8.8 (out of 10) is a remote code execution security breach that exploits a flaw in MSHTML. The MSHTML service is a dedicated browser engine used to display web content within Office documents. By sending a Word file, the hacker opens a window in the destination browser and, by controlling the vulnerable browser, easily infects the victim system and carries out its attacks.

**The term zero-day may refer to the vulnerability itself, or an attack that has zero days between the time the vulnerability is discovered and the first attack.**[[2]](https://krebsonsecurity.com/2021/09/microsoft-attackers-exploiting-windows-zero-day-flaw)

No solution has been released for this vulnerability, but users can reduce the risk by disabling all ActiveX controls in Internet Explorer.


We are going to analyse the exploit sample from :

ðŸ“Œcourt.docx: https://bazaar.abuse.ch/sample/938545f7bbe40738908a95da8cdeabb2a11ce2ca36b0f6a74deda9378d380a52/

ðŸ“Œside.html: https://bazaar.abuse.ch/sample/d0fd7acc38b3105facd6995344242f28e45f5384c0fdf2ec93ea24bfbc1dc9e6

ðŸ“Œministry.cab: https://bazaar.abuse.ch/sample/1fb13a158aff3d258b8f62fe211fabeed03f0763b2acadbccad9e8e39969ea00

Here is the PoC(proof of concept) of this vulnerability.

A proof of concept is a demonstration that a certain idea or method works. . In the context of computer security, this usually indicates that hackers have demonstrated their ability to exploit a software or hardware security flaw. 

https://user-images.githubusercontent.com/90869009/160339677-2731dd37-116e-41e9-9b11-150d1466c306.mp4


# *The CVE-2021-40444 Exploit Mechanism*

As you may know, Docx files are made up of a collection of XML files enclosed in a ZIP package. Unzipping the contents of a new Word document allows you to see what's inside.

![1](https://user-images.githubusercontent.com/90869009/160325889-18092c10-3ef7-4664-b85c-6e3a0eb9a33f.jpg)

In the ~/word dierectory the  "document.xml" contains the contents of your Docx file in XML format. There is another important doc file, the "document.xml.rels" in ~/word/-Rels  which is normaly an  XML file that maps relationships between internal/External resources such as (font, theme, and web settings, etc.) within the docx file. 

But in malicious word documents when you open document.xml.rels, you'll see an interesting external URL that leads to an html file (side.html). 

![2](https://user-images.githubusercontent.com/90869009/160345733-16d6bafb-4c18-489f-94cf-f27b573172ca.jpg)


The relationship with Id="rID6â€³ is loaded by the main document.xml file:

![3](https://user-images.githubusercontent.com/90869009/160345152-c46d78e5-156a-4445-a816-62cd644f559a.jpg)

What is this for? In fact, an html http request is sent to the server by side.html to download a .cab file (ministry.cab). " A file with the .CAB file extension is a Windows Cabinet file (they used to be called Diamond files). They're compressed files that store data related to various Windows installations that might involve device drivers or system files".[[3]](https://www.lifewire.com/cab-file-4144227)

![4](https://user-images.githubusercontent.com/90869009/160354082-c449fe4a-532e-49a3-947b-195443d8330a.jpg)

After downloading the cab file, the championship.inf, an .inf file inside the cab file, containing malicious code, will be executed by Rundll.32  through the CPL command and the  Directory Traversal vulnerability.
![5](https://user-images.githubusercontent.com/90869009/160354128-9284f439-07e5-4c92-ab3a-5c8ec440372d.jpg)

Rundll32 is a Windows utility responsible for loading and running 32-bit Dynamic Link Library (DLL) files. Attackers need this exe file to run their malicious code which  creates a VirtualAlloc and CreateThread to return a reverse shell to the attacker.

![image-20210911115854255](https://user-images.githubusercontent.com/90869009/160362570-f3a63451-f009-4bf7-b979-95c41493eee8.png)


 # *References*
 [[1]. https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-40444](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-40444)
 
 [[2].  https://www.sciencedirect.com/topics/computer-science/zero-day-attack]( https://www.sciencedirect.com/topics/computer-science/zero-day-attack).

 [[3]. https://www.lifewire.com/cab-file-4144227](https://www.lifewire.com/cab-file-4144227)
 
 [[4]. https://www.microsoft.com/security/blog/2021/09/15/analyzing-attacks-that-exploit-the-mshtml-cve-2021-40444-vulnerability/](https://www.microsoft.com/security/blog/2021/09/15/analyzing-attacks-that-exploit-the-mshtml-cve-2021-40444-vulnerability/)






